<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html"><link rel="search" title="Search" href="search.html"><link rel="next" title="Coding Convention" href="CodingConvention.html"><link rel="prev" title="Getting Started" href="GettingStarted.html">

    <!-- Generated with Sphinx 8.2.3 and Furo 2025.09.25 -->
        <title>Python Bindings - µFFT 0.94.0-67-g68fe7c6 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">µFFT 0.94.0-67-g68fe7c6
 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <span class="sidebar-brand-text">µFFT 0.94.0-67-g68fe7c6
 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Summary.html">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="GettingStarted.html">Getting Started</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Python Bindings</a></li>
<li class="toctree-l1"><a class="reference internal" href="CodingConvention.html">Coding Convention</a></li>
<li class="toctree-l1"><a class="reference internal" href="CplusplusAPI.html">C++ API Reference</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="_sources/Python.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="python-bindings">
<h1>Python Bindings<a class="headerlink" href="#python-bindings" title="Link to this heading">¶</a></h1>
<section id="fast-fourier-transform">
<h2>Fast-Fourier Transform<a class="headerlink" href="#fast-fourier-transform" title="Link to this heading">¶</a></h2>
<p>The core of µFFT is the Fast-Fourier-Transform (FFT) abstraction layer,
implemented as a class which is specialized for a given FFT engine. Currently
supported are
<a class="reference external" href="https://github.com/mreineck/pocketfft">pocketfft</a>,
<a class="reference external" href="https://www.fftw.org">FFTW</a>,
<a class="reference external" href="https://www.fftw.org/fftw3_doc/FFTW-MPI-Installation.html">MPIFFTW</a>
and
<a class="reference external" href="https://github.com/mpip/pfft">PFFT</a>.
In our experience, <em>PFFT</em> has the best scaling properties for large-scale parallel
FFTs because it uses pencil decomposition. Only <em>pocketfft</em> is enabled by default.</p>
<p>The FFTs operate on <a class="reference external" href="https://github.com/muSpectre/muGrid">µGrid</a> fields. The
engines creates fields with the right memory layout for the respective FFT engine.
Please read the µGrid
<a class="reference external" href="https://muspectre.github.io/muGrid/Python.html">documentation</a> before starting here.</p>
</section>
<section id="the-fft-class">
<h2>The FFT class<a class="headerlink" href="#the-fft-class" title="Link to this heading">¶</a></h2>
<p>Instantiating an FFT object is a simple as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">muFFT</span><span class="w"> </span><span class="kn">import</span> <span class="n">FFT</span>
<span class="n">fft</span> <span class="o">=</span> <span class="n">FFT</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pocketfft&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>where <cite>[nx, ny, nz]</cite> is the shape of the grid and the optional <cite>engine</cite> is the FFT
engine to use. The FFT class takes another optional <cite>comm</cite> parameter that can be
either a <cite>mpi4py</cite> communicator or an native muFFT <cite>Communicator</cite>. If no communicator
is provided, the FFT class will use the default communicator <cite>MPI_COMM_SELF</cite>.</p>
</section>
<section id="grid-interface">
<h2>µGrid interface<a class="headerlink" href="#grid-interface" title="Link to this heading">¶</a></h2>
<p>The FFT class provides methods to obtain real-valued real-space fields and complex-valued
Fourier-space fields. The transform operates between these fields. An example of a simple
transform is shown here:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">muFFT</span><span class="w"> </span><span class="kn">import</span> <span class="n">FFT</span>

<span class="c1"># Instantiate a FFT object with the PocketFFT engine</span>
<span class="n">nb_grid_pts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="n">fft</span> <span class="o">=</span> <span class="n">FFT</span><span class="p">(</span><span class="n">nb_grid_pts</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pocketfft&#39;</span><span class="p">)</span>

<span class="c1"># Obtain a real and a Fourie-space field</span>
<span class="n">rfield</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">real_space_field</span><span class="p">(</span><span class="s1">&#39;rfield&#39;</span><span class="p">)</span>
<span class="n">ffield</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fourier_space_field</span><span class="p">(</span><span class="s1">&#39;ffield&#39;</span><span class="p">)</span>

<span class="c1"># Fill field with random numbers</span>
<span class="n">rfield</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">nb_grid_pts</span><span class="p">)</span>

<span class="c1"># Perform a forward FFT</span>
<span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">rfield</span><span class="p">,</span> <span class="n">ffield</span><span class="p">)</span>

<span class="c1"># Perform an inverse FFT</span>
<span class="n">r2field</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">real_space_field</span><span class="p">(</span><span class="s1">&#39;second rfield&#39;</span><span class="p">)</span>
<span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">ffield</span><span class="p">,</span> <span class="n">r2field</span><span class="p">)</span>

<span class="c1"># Check that the original and the reconstructed field are the same</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">rfield</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">r2field</span><span class="o">.</span><span class="n">p</span> <span class="o">*</span> <span class="n">fft</span><span class="o">.</span><span class="n">normalisation</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="convenience-numpy-interface">
<h2>Convenience numpy interface<a class="headerlink" href="#convenience-numpy-interface" title="Link to this heading">¶</a></h2>
<p>The FFT class also provides a convenience interface that allows usage of <cite>numpy</cite> arrays
directly. Internally, the <cite>numpy</cite> arrays are converted to µGrid fields. The following
shows an example of the convenience interface:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">muFFT</span><span class="w"> </span><span class="kn">import</span> <span class="n">FFT</span>

<span class="c1"># Instantiate a FFT object with the PocketFFT engine</span>
<span class="n">nb_grid_pts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="n">fft</span> <span class="o">=</span> <span class="n">FFT</span><span class="p">(</span><span class="n">nb_grid_pts</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pocketfft&#39;</span><span class="p">,</span>
          <span class="n">allow_temporary_buffer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Create a random real-space field as a numpy array</span>
<span class="n">rarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">nb_grid_pts</span><span class="p">)</span>

<span class="c1"># The convenience interface can work with numpy array directly, but this</span>
<span class="c1"># implies intermediate temporary copies of the numpy arrays</span>
<span class="n">farr</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">rarr</span><span class="p">)</span>

<span class="c1"># Convert back</span>
<span class="n">r2arr</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">farr</span><span class="p">)</span>

<span class="c1"># Check that the original and the reconstructed field are the same</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">rarr</span><span class="p">,</span> <span class="n">r2arr</span> <span class="o">*</span> <span class="n">fft</span><span class="o">.</span><span class="n">normalisation</span><span class="p">)</span>
</pre></div>
</div>
<p>The downside of the convenience interface is that temporary copies are typically created.
The reason for this is that most FFT engines have strict requirements on the memory
layout. The µGrid interface allows to create fields with the right memory layout directly,
avoiding copies.</p>
<p>Temporary copies can be disabled entirely by setting the <cite>allow_temporary_buffer</cite> option
to <cite>false</cite>. The above example then still runs for the <cite>pocketfft</cite> engine, but will fail
with the error:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="nl">RuntimeError</span><span class="p">:</span><span class="w"> </span><span class="n">Incompatible</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">layout</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">real</span><span class="o">-</span><span class="n">space</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">temporary</span>
<span class="n">copies</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">allowed</span><span class="p">.</span>
</pre></div>
</div>
<p>for <cite>fftw</cite> which requires a padded memory layout.</p>
</section>
<section id="normalization">
<h2>Normalization<a class="headerlink" href="#normalization" title="Link to this heading">¶</a></h2>
<p>All µFFT transforms are not normalized. A round-trip forward-inverse transform will pick
up a global factor, that can be compensated by multiplying with the value of the
<cite>normlization</cite> property of the FFT object as in the examples above.</p>
<p>The reason for this is that there is a choice of putting the factor into the forward or
inverse transform, or putting the square-root of the factor into both. µFFT leaves the
choice of normalization to the user.</p>
<p>More information can be found for example in the
<a class="reference external" href="https://numpy.org/doc/stable/reference/routines.fft.html#normalization">section on normalization</a>
of the <cite>numpy</cite> documentation.</p>
</section>
<section id="coordinates-and-wavevectors">
<h2>Coordinates and wavevectors<a class="headerlink" href="#coordinates-and-wavevectors" title="Link to this heading">¶</a></h2>
<p>Wavevectors are obtained via the <cite>fftfreq</cite> property of the FFT object. The result is
identical to the
<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.fft.fftfreq.html">numpy.fft.fftfreq</a>
function. µFFT adds a second convenience method <cite>ifftfreq</cite>, which returns an array of integers
that indicate the index of the wavevector in the Fourier-space field. This is the same as the output
of <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.fft.fftfreq.html">numpy.fft.fftfreq</a>
with <cite>d=1/n</cite>. The following example shows how to obtain a gradient field using a Fourier derivative
that uses the <cite>ifftfreq</cite> property:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">muFFT</span><span class="w"> </span><span class="kn">import</span> <span class="n">FFT</span>

<span class="c1"># Instantiate a FFT object with the PocketFFT engine</span>
<span class="n">nb_grid_pts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">54</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<span class="n">physical_sizes</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">)</span>  <span class="c1"># Sizes of the domain (in arbitrary units)</span>
<span class="n">fft</span> <span class="o">=</span> <span class="n">FFT</span><span class="p">(</span><span class="n">nb_grid_pts</span><span class="p">)</span>

<span class="c1"># Compute wavevectors (2 * pi * k / L for all k and in all directions)</span>
<span class="n">wavevectors</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">fft</span><span class="o">.</span><span class="n">ifftfreq</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">physical_sizes</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># Obtain a real field and fill it</span>
<span class="n">rfield</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">real_space_field</span><span class="p">(</span><span class="s1">&#39;scalar field&#39;</span><span class="p">)</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">coords</span>
<span class="n">rfield</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># Just a sine</span>

<span class="c1"># Compute Fourier transform</span>
<span class="n">ffield</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fourier_space_field</span><span class="p">(</span><span class="s1">&#39;scalar field&#39;</span><span class="p">)</span>
<span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">rfield</span><span class="p">,</span> <span class="n">ffield</span><span class="p">)</span>

<span class="c1"># Compute Fourier gradient by multiplying with wavevector</span>
<span class="n">fgrad</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fourier_space_field</span><span class="p">(</span><span class="s1">&#39;gradient field&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,))</span>
<span class="n">fgrad</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">wavevectors</span> <span class="o">*</span> <span class="n">ffield</span><span class="o">.</span><span class="n">p</span>

<span class="c1"># Inverse transform to get gradient in real space</span>
<span class="n">rgrad</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">real_space_field</span><span class="p">(</span><span class="s1">&#39;gradient field&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,))</span>
<span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">fgrad</span><span class="p">,</span> <span class="n">rgrad</span><span class="p">)</span>

<span class="c1"># Normalize gradient (µFFT does not normalize the transform)</span>
<span class="n">gradx</span><span class="p">,</span> <span class="n">grady</span> <span class="o">=</span> <span class="n">rgrad</span><span class="o">.</span><span class="n">p</span> <span class="o">*</span> <span class="n">fft</span><span class="o">.</span><span class="n">normalisation</span>

<span class="c1"># Gradient in x is cosine</span>
<span class="n">lx</span><span class="p">,</span> <span class="n">ly</span> <span class="o">=</span> <span class="n">physical_sizes</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">gradx</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">lx</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>
<span class="c1"># Gradient in y is zero</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">grady</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>
</pre></div>
</div>
<p>The result of <cite>fftfreq</cite> can be regarded as a fractional Fourier-space coordinate,
the result of <cite>ifftfreq</cite> and an integer Fourier-space coordinate.
There are also convenience properties <cite>coords</cite> and <cite>icoords</cite> that yield the fractional
and integer coordinates in real-space. These properties are useful in particular when
running MPI-parallel with domain decomposition. All properties then return just the coordinates of
the local domain.</p>
</section>
<section id="derivatives">
<h2>Derivatives<a class="headerlink" href="#derivatives" title="Link to this heading">¶</a></h2>
<p>While it is possible to manually compute the derivative as in the above example, µFFT provides
utility classes that compute the derivative in Fourier space. The following example shows how to
compute the gradient of a field using the <cite>FourierDerivative</cite> class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">muFFT</span><span class="w"> </span><span class="kn">import</span> <span class="n">FFT</span><span class="p">,</span> <span class="n">FourierDerivative</span>

<span class="c1"># Instantiate a FFT object with the PocketFFT engine</span>
<span class="n">nb_grid_pts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">54</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<span class="n">physical_sizes</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">)</span>  <span class="c1"># Sizes of the domain (in arbitrary units)</span>
<span class="n">grid_spacing_x</span><span class="p">,</span> <span class="n">grid_spacing_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">physical_sizes</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nb_grid_pts</span><span class="p">)</span>
<span class="n">fft</span> <span class="o">=</span> <span class="n">FFT</span><span class="p">(</span><span class="n">nb_grid_pts</span><span class="p">)</span>

<span class="c1"># Construct Fourier derivative</span>
<span class="n">fourier_x</span> <span class="o">=</span> <span class="n">FourierDerivative</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Derivative in x direction</span>
<span class="n">fourier_y</span> <span class="o">=</span> <span class="n">FourierDerivative</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Derivative in y direction</span>

<span class="c1"># Obtain a real field and fill it</span>
<span class="n">rfield</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">real_space_field</span><span class="p">(</span><span class="s1">&#39;scalar field&#39;</span><span class="p">)</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">coords</span>
<span class="n">rfield</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># Just a sine</span>

<span class="c1"># Compute Fourier transform</span>
<span class="n">ffield</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fourier_space_field</span><span class="p">(</span><span class="s1">&#39;scalar field&#39;</span><span class="p">)</span>
<span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">rfield</span><span class="p">,</span> <span class="n">ffield</span><span class="p">)</span>

<span class="c1"># Compute Fourier gradient by multiplying with wavevector</span>
<span class="n">fgrad</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fourier_space_field</span><span class="p">(</span><span class="s1">&#39;gradient field&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,))</span>
<span class="n">fgrad</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fourier_x</span><span class="o">.</span><span class="n">fourier</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">)</span> <span class="o">*</span> <span class="n">ffield</span><span class="o">.</span><span class="n">p</span> <span class="o">/</span> <span class="n">grid_spacing_x</span>
<span class="n">fgrad</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fourier_y</span><span class="o">.</span><span class="n">fourier</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">)</span> <span class="o">*</span> <span class="n">ffield</span><span class="o">.</span><span class="n">p</span> <span class="o">/</span> <span class="n">grid_spacing_y</span>

<span class="c1"># Inverse transform to get gradient in real space</span>
<span class="n">rgrad</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">real_space_field</span><span class="p">(</span><span class="s1">&#39;gradient field&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,))</span>
<span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">fgrad</span><span class="p">,</span> <span class="n">rgrad</span><span class="p">)</span>

<span class="c1"># Normalize gradient (µFFT does not normalize the transform)</span>
<span class="n">gradx</span><span class="p">,</span> <span class="n">grady</span> <span class="o">=</span> <span class="n">rgrad</span><span class="o">.</span><span class="n">p</span> <span class="o">*</span> <span class="n">fft</span><span class="o">.</span><span class="n">normalisation</span>

<span class="c1"># Gradient in x is cosine</span>
<span class="n">lx</span><span class="p">,</span> <span class="n">ly</span> <span class="o">=</span> <span class="n">physical_sizes</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">gradx</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">lx</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>
<span class="c1"># Gradient in y is zero</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">grady</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>
</pre></div>
</div>
<p>In a similar fashion, µFFT provides utility classes for discrete derivatives. The <cite>DiscreteDerivative</cite>
class accepts a stencil and computes the derivative in Fourier space. The following example shows how to
compute the gradient of a field using the <cite>DiscreteDerivative</cite> class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">muFFT</span><span class="w"> </span><span class="kn">import</span> <span class="n">FFT</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">muFFT.Stencils2D</span><span class="w"> </span><span class="kn">import</span> <span class="n">upwind_x</span><span class="p">,</span> <span class="n">upwind_y</span>

<span class="c1"># Instantiate a FFT object with the PocketFFT engine</span>
<span class="n">nb_grid_pts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">54</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<span class="n">physical_sizes</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">)</span>  <span class="c1"># Sizes of the domain (in arbitrary units)</span>
<span class="n">grid_spacing_x</span><span class="p">,</span> <span class="n">grid_spacing_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">physical_sizes</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nb_grid_pts</span><span class="p">)</span>
<span class="n">fft</span> <span class="o">=</span> <span class="n">FFT</span><span class="p">(</span><span class="n">nb_grid_pts</span><span class="p">)</span>

<span class="c1"># Obtain a real field and fill it</span>
<span class="n">rfield</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">real_space_field</span><span class="p">(</span><span class="s1">&#39;scalar field&#39;</span><span class="p">)</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">coords</span>
<span class="n">rfield</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># Just a sine</span>

<span class="c1"># Compute Fourier transform</span>
<span class="n">ffield</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fourier_space_field</span><span class="p">(</span><span class="s1">&#39;scalar field&#39;</span><span class="p">)</span>
<span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">rfield</span><span class="p">,</span> <span class="n">ffield</span><span class="p">)</span>

<span class="c1"># Compute gradient by multiplying with wavevector</span>
<span class="n">fgrad</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fourier_space_field</span><span class="p">(</span><span class="s1">&#39;gradient field&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,))</span>
<span class="n">fgrad</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">upwind_x</span><span class="o">.</span><span class="n">fourier</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">)</span> <span class="o">*</span> <span class="n">ffield</span><span class="o">.</span><span class="n">p</span> <span class="o">/</span> <span class="n">grid_spacing_x</span>
<span class="n">fgrad</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">upwind_y</span><span class="o">.</span><span class="n">fourier</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">)</span> <span class="o">*</span> <span class="n">ffield</span><span class="o">.</span><span class="n">p</span> <span class="o">/</span> <span class="n">grid_spacing_y</span>

<span class="c1"># Inverse transform to get gradient in real space</span>
<span class="n">rgrad</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">real_space_field</span><span class="p">(</span><span class="s1">&#39;gradient field&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,))</span>
<span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">fgrad</span><span class="p">,</span> <span class="n">rgrad</span><span class="p">)</span>

<span class="c1"># Normalize gradient (µFFT does not normalize the transform)</span>
<span class="n">gradx</span><span class="p">,</span> <span class="n">grady</span> <span class="o">=</span> <span class="n">rgrad</span><span class="o">.</span><span class="n">p</span> <span class="o">*</span> <span class="n">fft</span><span class="o">.</span><span class="n">normalisation</span>

<span class="c1"># Gradient in x is the finite difference of the sine</span>
<span class="n">lx</span><span class="p">,</span> <span class="n">ly</span> <span class="o">=</span> <span class="n">physical_sizes</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">gradx</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">rfield</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">rfield</span><span class="o">.</span><span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="n">grid_spacing_x</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>
<span class="c1"># Gradient in y is zero</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">grady</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>
</pre></div>
</div>
<p>The modules <cite>muFFT.Stencils1D</cite>, <cite>muFFT.Stencils2D</cite> and <cite>muFFT.Stencils3D</cite> provide a number of predefined
stencils that are implemented via the <cite>DiscreteDerivative</cite> class.</p>
</section>
<section id="parallelization">
<h2>Parallelization<a class="headerlink" href="#parallelization" title="Link to this heading">¶</a></h2>
<p>The previous example can be parallelized by initializing the FFT engine with an MPI communicator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpi4py</span><span class="w"> </span><span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">muGrid</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileIONetCDF</span><span class="p">,</span> <span class="n">OpenMode</span><span class="p">,</span> <span class="n">Communicator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">muFFT</span><span class="w"> </span><span class="kn">import</span> <span class="n">FFT</span>

<span class="c1"># Instantiate a FFT object with the PocketFFT engine</span>
<span class="n">nb_grid_pts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="n">physical_sizes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Sizes of the domain (in arbitrary units)</span>
<span class="n">fft</span> <span class="o">=</span> <span class="n">FFT</span><span class="p">(</span><span class="n">nb_grid_pts</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;mpi&#39;</span><span class="p">,</span> <span class="n">communicator</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>

<span class="k">if</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Rank   Size          Domain       Subdomain        Location&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  ----   ----          ------       ---------        --------&#39;</span><span class="p">)</span>
<span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>  <span class="c1"># Barrier so header is printed first</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">rank</span><span class="si">:</span><span class="s1">6</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">size</span><span class="si">:</span><span class="s1">6</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">nb_domain_grid_pts</span><span class="p">)</span><span class="si">:</span><span class="s1">&gt;15</span><span class="si">}</span><span class="s1"> &#39;</span>
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">nb_subdomain_grid_pts</span><span class="p">)</span><span class="si">:</span><span class="s1">&gt;15</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">subdomain_locations</span><span class="p">)</span><span class="si">:</span><span class="s1">&gt;15</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Compute wavevectors (2 * pi * k / L for all k and in all directions)</span>
<span class="n">wavevectors</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">fft</span><span class="o">.</span><span class="n">ifftfreq</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">physical_sizes</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># Obtain a real field and fill it</span>
<span class="n">rfield</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">real_space_field</span><span class="p">(</span><span class="s1">&#39;scalar-field&#39;</span><span class="p">)</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">coords</span>
<span class="n">rfield</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># Just a sine</span>

<span class="c1"># Compute Fourier transform</span>
<span class="n">ffield</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fourier_space_field</span><span class="p">(</span><span class="s1">&#39;scalar-field&#39;</span><span class="p">)</span>
<span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">rfield</span><span class="p">,</span> <span class="n">ffield</span><span class="p">)</span>

<span class="c1"># Compute Fourier gradient by multiplying with wavevector</span>
<span class="n">fgrad</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fourier_space_field</span><span class="p">(</span><span class="s1">&#39;gradient-field&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
<span class="n">fgrad</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">wavevectors</span> <span class="o">*</span> <span class="n">ffield</span><span class="o">.</span><span class="n">p</span>

<span class="c1"># Inverse transform to get gradient in real space</span>
<span class="n">rgrad</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">real_space_field</span><span class="p">(</span><span class="s1">&#39;gradient-field&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
<span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">fgrad</span><span class="p">,</span> <span class="n">rgrad</span><span class="p">)</span>

<span class="c1"># Normalize gradient (µFFT does not normalize the transform)</span>
<span class="n">gradx</span><span class="p">,</span> <span class="n">grady</span><span class="p">,</span> <span class="n">gradz</span> <span class="o">=</span> <span class="n">rgrad</span><span class="o">.</span><span class="n">p</span> <span class="o">*</span> <span class="n">fft</span><span class="o">.</span><span class="n">normalisation</span>

<span class="c1"># Gradient in x is cosine</span>
<span class="n">lx</span><span class="p">,</span> <span class="n">ly</span><span class="p">,</span> <span class="n">lz</span> <span class="o">=</span> <span class="n">physical_sizes</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span>
    <span class="n">gradx</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">lx</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>
<span class="c1"># Gradient in y is also cosine</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span>
    <span class="n">grady</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">ly</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>
<span class="c1"># Gradient in z is zero</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">gradz</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>

<span class="c1"># I/O example</span>
<span class="n">file</span> <span class="o">=</span> <span class="n">FileIONetCDF</span><span class="p">(</span><span class="s1">&#39;example.nc&#39;</span><span class="p">,</span> <span class="n">open_mode</span><span class="o">=</span><span class="n">OpenMode</span><span class="o">.</span><span class="n">Overwrite</span><span class="p">,</span>
                    <span class="n">communicator</span><span class="o">=</span><span class="n">Communicator</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">))</span>
<span class="n">file</span><span class="o">.</span><span class="n">register_field_collection</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">real_field_collection</span><span class="p">)</span>
<span class="n">file</span><span class="o">.</span><span class="n">append_frame</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
</pre></div>
</div>
<p>The engine that is selected must support MPI parallelization. Currently, only the <cite>fftwmpi</cite> engine
and <cite>pfft</cite> engine support MPI parallelization. Using <cite>mpi</cite> as in the example autoselects an engine.</p>
<p>The parallelization employs domain decomposition. The domain is split into stripe-shaped subdomains
for <cite>fftwmpi</cite> and pencil-shaped subdomains for <cite>pfft</cite>. <cite>pfft</cite> scales better to large numbers of MPI
processes because of this pencil decomposition. The number of grid points on the local domain is
returned by <cite>nb_subdomain_grid_pts</cite> and the location of the domain is given by <cite>subdomain_locations</cite>.
Note that in a typical code uses <cite>coords</cite>, <cite>icoord</cite>, <cite>fftfreq</cite> and <cite>ifftfreq</cite> as above and does not
need to care about the actual details of the decomposition, as those properties return the domain-local
coordinates and wavevectors.</p>
<p>The above example also illustrates how to write the global field to a file.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="CodingConvention.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Coding Convention</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="GettingStarted.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Getting Started</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2017-2022 Till Junge, 2018-2024 Lars Pastewka
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Python Bindings</a><ul>
<li><a class="reference internal" href="#fast-fourier-transform">Fast-Fourier Transform</a></li>
<li><a class="reference internal" href="#the-fft-class">The FFT class</a></li>
<li><a class="reference internal" href="#grid-interface">µGrid interface</a></li>
<li><a class="reference internal" href="#convenience-numpy-interface">Convenience numpy interface</a></li>
<li><a class="reference internal" href="#normalization">Normalization</a></li>
<li><a class="reference internal" href="#coordinates-and-wavevectors">Coordinates and wavevectors</a></li>
<li><a class="reference internal" href="#derivatives">Derivatives</a></li>
<li><a class="reference internal" href="#parallelization">Parallelization</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=d2e26c1e"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>